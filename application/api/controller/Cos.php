<?php
/**
 * Created by PhpStorm.
 * User: Jason
 * Date: 2017/9/19
 * Time: 21:22
 */
namespace app\api\controller;

use app\index\model\UserSetting;
use think\Controller;
use think\Cookie;
use think\Response;
use app\index\model\UserSetting as UserSettingModel;
use QCloud\Cos\Api;

/**
 * 云存储api控制器
 * Class Cos
 * @package app\api\controller
 */
class Cos extends Controller {

    protected $user_setting_model;
    protected $cosApi;
    protected $bucket;

    public function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
        if (!Cookie::get('appid')) {
            $result = [
                'error'   => 1,
                'message' => '请先进行配置'
            ];
            exit($this->response($result)->send());
        }
        $this->user_setting_model = new UserSettingModel();
        $data = $this->user_setting_model->where(['app_id'=>Cookie::get('appid')])->find()->toArray();
        $config['app_id']      = $data['app_id'];
        $config['secret_id']   = $data['secret_id'];
        $config['secret_key']  = $data['secret_key'];
        $config['region']      = $data['region'];
        $config['timeout']     = $data['timeout'];

        $this->bucket = $data['bucketname'];

        $this->cosApi = new Api($config);
    }

    /**
     * 输出返回数据
     */
    public function response($result, $type = 'json')
    {
        return Response::create($result, $type)->code(200);
    }

    /**
     * 获取列表数据
     * url: /api/cos/getlist
     */
    public function getList($folder = "/")
    {
        $ret = $this->cosApi->listFolder($this->bucket, $folder);
        return json($ret);
    }
}